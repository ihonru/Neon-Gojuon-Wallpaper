<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Neon Gojuon Wallpaper</title>
    <style>
        :root {
            --bg-color: #08080a;
            --text-color: #ffffff;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00aa;
            /* Enhanced Glass Variables */
            --glass-bg: rgba(30, 30, 35, 0.4); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-highlight: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.6);
            --font-jp: "Noto Sans JP", sans-serif;
            --font-mono: "JetBrains Mono", monospace;
            
            /* Dynamic Grid Variables */
            --cell-size: 4.6rem;
            --grid-gap: 0.8rem; /* Reduced default gap */
        }

        /* Fix alignment issues globally */
        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-jp);
            overflow: hidden;
            height: 100vh;
            height: 100dvh; 
            user-select: none;
            display: flex;
            flex-direction: column;
        }

        /* --- Background Effects --- */
        
        /* 1. Cinematic Glow (Bottom Light) */
        .cinematic-glow {
            position: absolute; 
            bottom: -500px; 
            left: 50%;
            width: 1500px; 
            height: 1000px; 
            margin-left: -750px;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(0, 243, 255, 0.15) 0%, rgba(0, 60, 150, 0.08) 40%, transparent 70%);
            filter: blur(80px); 
            mix-blend-mode: screen;
            animation: movie-flow 25s ease-in-out infinite;
            z-index: 1;
            pointer-events: none;
        }

        /* 2. Dust Canvas */
        #dustCanvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 2;
            pointer-events: none; 
            width: 100%;
            height: 100%;
        }

        @keyframes movie-flow {
            0%, 100% { transform: translateX(-10%) scale(1); filter: blur(80px) hue-rotate(0deg); }
            50% { transform: translateX(10%) scale(1.05, 0.95); filter: blur(60px) hue-rotate(30deg); }
        }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        
        /* --- Header & Top Controls --- */
        header {
            position: absolute;
            top: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .header-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        header .ui-bar {
            display: flex;
            gap: 4px; 
            padding: 4px; 
            border-radius: 999px; /* Pill shape */
            background: rgba(30, 30, 35, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        
        header .ui-bar:hover {
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.3);
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(30, 30, 35, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #888;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.15);
            color: white;
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.3);
        }
        
        .icon-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        button {
            background: transparent;
            border: none;
            color: #888;
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            padding: 6px 16px; /* Compact padding */
            border-radius: 999px; /* Full round buttons */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .mode-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #050505;
            box-shadow: 0 2px 10px rgba(255,255,255,0.25);
            font-weight: 700;
        }
        
        .mode-btn:not(.active):hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        /* --- Settings Panel --- */
        #settings-panel {
            position: fixed;
            top: 5rem; /* Below header */
            right: 2rem;
            width: 242px; /* Approx aligned with Tabs + Gap + Settings Button */
            max-width: calc(100vw - 4rem);
            background: rgba(18, 18, 22, 0.9);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            z-index: 300;
            box-shadow: 0 25px 60px rgba(0,0,0,0.9);
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px); /* Slide down effect */
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex;
            flex-direction: column;
        }

        #settings-panel.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        /* New Toolbar */
        .settings-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .settings-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
        }

        /* Consistent Hover Effects */
        .btn-close-settings:hover {
            border-color: #ff4444;
            color: #ff4444;
            background: rgba(255, 50, 50, 0.1);
            box-shadow: 0 0 15px rgba(255, 50, 50, 0.3);
            transform: rotate(90deg);
        }

        .btn-reset-settings:hover {
            border-color: var(--neon-blue);
            color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            transform: rotate(-180deg);
        }
        
        .settings-action-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
            stroke: currentColor;
        }
        
        /* Content Titles */
        .settings-section-title {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--neon-pink);
            letter-spacing: 1.5px;
            margin-bottom: 2px; 
            opacity: 0.8;
            font-weight: bold;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between Label and Slider */
            margin-bottom: 28px; /* Distance between groups */
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-family: var(--font-jp);
            font-size: 12px;
            color: #aaa;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .slider-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-mono);
            font-size: 9px;
            color: rgba(255,255,255,0.3);
            text-transform: uppercase;
        }

        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            width: 100%;
            background: transparent; 
            display: block;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            margin-top: -5px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            border: 2px solid rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
        }

        input[type=range]:focus {
            outline: none;
        }
        
        #settings-overlay {
            position: fixed;
            inset: 0;
            z-index: 299;
            background: rgba(0,0,0,0.2); 
            display: none;
        }
        #settings-overlay.active { display: block; }

        /* --- Main Grid --- */
        main {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            z-index: 20; 
            position: relative;
        }

        .grid-container {
            display: flex;
            flex-direction: row-reverse;
            gap: var(--grid-gap);
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: var(--grid-gap);
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border-radius: 1.25rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            backdrop-filter: blur(4px); /* Light blur */
            
            /* -- Local Glow Logic -- */
            --x: 50%; 
            --y: 50%;
            
            border: 1px solid transparent; 
            
            /* Transparent Glass Background */
            /* Using lower alpha values for transparency */
            background: 
                linear-gradient(rgba(30, 30, 35, 0.4), rgba(30, 30, 35, 0.4)) padding-box,
                linear-gradient(rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.1)) border-box;

            transition: transform 0.2s ease-out, box-shadow 0.2s ease;
        }

        .cell.empty-cell {
            opacity: 0;
            pointer-events: none;
            border-color: transparent; 
            background: transparent;
            box-shadow: none;
        }

        @media (hover: hover) {
            .cell:not(.empty-cell):hover {
                transform: scale(1.05); 
                z-index: 10;
                /* Brighter on hover but still glassy */
                background: 
                    linear-gradient(rgba(40, 40, 50, 0.6), rgba(40, 40, 50, 0.6)) padding-box,
                    radial-gradient(80px circle at var(--x) var(--y), rgba(255, 255, 255, 0.6), transparent 100%) border-box;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            }
        }

        .cell.placeholder {
            opacity: 0; 
            pointer-events: none;
        }

        .cell-main {
            font-size: calc(var(--cell-size) * 0.43); 
            font-weight: 300;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1;
            position: absolute;
            top: 36%; 
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            z-index: 2; 
        }

        .cell-sub {
            font-size: 10px;
            font-family: var(--font-mono);
            font-weight: 500;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 2px;
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            z-index: 2;
        }

        /* --- Info Panel --- */
        #info-panel {
            position: fixed;
            z-index: 200;
            display: none; 
            overflow: hidden;
            
            background: rgba(15, 15, 20, 0.90); /* High opacity for readability */
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            
            border: 1px solid rgba(255, 255, 255, 0.1); 
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
            
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* Content inside the panel */
        #panel-content {
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            padding: 2.5rem 3rem;
            position: relative;
        }

        #info-panel.open #panel-content {
            opacity: 1;
            transition-delay: 0.1s; 
        }

        .panel-bg-glow {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.05), transparent 70%);
            pointer-events: none;
        }

        /* --- Panel Drag Handle (Mobile) --- */
        .panel-handle {
            display: none;
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            z-index: 70;
            pointer-events: none;
        }

        /* --- Buttons --- */
        .btn-action {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            color: #888;
            background: rgba(255,255,255,0.05);
            font-family: var(--font-jp);
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            transition: all 0.3s ease;
            z-index: 50;
        }

        .btn-action:hover {
            border-color: var(--neon-pink);
            color: var(--neon-pink);
            background: rgba(255, 0, 170, 0.1);
            box-shadow: 0 0 15px rgba(255, 0, 170, 0.3);
            transform: rotate(90deg);
        }

        .btn-action svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        
        .btn-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 60;
            transition: all 0.3s ease;
            padding: 0;
        }
        
        .btn-close svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
        }
        
        .btn-close:hover {
            border-color: #ff4444;
            color: #ff4444;
            background: rgba(255, 50, 50, 0.1);
            box-shadow: 0 0 15px rgba(255, 50, 50, 0.3);
            transform: rotate(90deg);
        }

        /* Content Views */
        .char-view {
            display: flex;
            align-items: flex-start;
            justify-content: center; 
            gap: 3rem;
            width: 100%;
        }

        .char-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-width: 80px;
            height: 120px;
        }

        .char-label {
            font-size: 11px;
            font-family: var(--font-mono);
            letter-spacing: 2px;
            margin-bottom: 0.75rem;
            color: #666;
            height: 15px;
        }

        .char-val {
            font-size: 4rem;
            font-weight: 400; 
            color: white;
            line-height: 1;
            margin-top: auto;
            margin-bottom: auto;
        }
        
        .char-val-romaji {
            font-size: 3.5rem; /* Visually balanced with 4rem Kana */
            font-family: var(--font-mono);
            font-weight: 400;
            color: white;
            line-height: 1;
            margin-top: auto;
            margin-bottom: auto;
            text-transform: uppercase;
        }

        .divider {
            width: 1px;
            height: 5rem;
            background: rgba(255,255,255,0.1);
            margin: 0 1rem;
            align-self: center;
        }

        .vocab-view {
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .vocab-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .vocab-main { display: flex; align-items: baseline; gap: 1rem; flex-wrap: wrap; }
        .vocab-word { font-size: 3rem; color: white; text-shadow: 0 0 10px rgba(255,255,255,0.2); line-height: 1; }
        .vocab-reading { font-size: 1.25rem; color: #888; white-space: nowrap; }
        
        .vocab-meaning { 
            color: var(--neon-blue); 
            font-size: 1.25rem; 
            font-weight: 300; 
            text-align: right;
            margin-left: auto;
            min-width: 120px;
        }

        .vocab-example { 
            background: rgba(255,255,255,0.05); 
            padding: 1rem 1.25rem;
            border-left: 3px solid rgba(255,0,170,0.5);
            color: #ccc;
            font-style: italic;
            font-size: 1rem;
            line-height: 1.5;
        }

        .error-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
        }

        .footer-watermark {
            position: fixed;
            bottom: 60px;
            left: 2rem;
            font-family: var(--font-mono);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.15);
            cursor: pointer;
            z-index: 50;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            pointer-events: auto;
            text-decoration: none;
        }

        .footer-watermark:hover {
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            opacity: 1;
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
                overflow: hidden; 
            }

            header {
                width: 100%;
                display: flex;
                justify-content: space-between; /* Spread content */
                padding: 1rem 1.5rem;
                top: env(safe-area-inset-top);
                right: auto;
                left: 0;
                background: linear-gradient(to bottom, var(--bg-color) 20%, transparent 100%);
                z-index: 50; 
                pointer-events: none;
            }

            header * {
                pointer-events: auto;
            }

            .header-group {
                /* On mobile, mode toggle centers */
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
            }
            
            /* Put settings on right */
            #btn-settings-toggle {
                position: absolute;
                right: 1.5rem;
            }

            #settings-panel {
                top: 5rem;
                right: 1.5rem;
            }

            main {
                padding: 0;
                align-items: flex-start;
                justify-content: flex-start;
                height: 100dvh; 
            }

            .grid-container { 
                flex-direction: column; 
                width: 100%;
                height: 100%;
                gap: 0.5rem; 
                padding: 5rem 1rem 4rem 1rem; 
                overflow-y: auto; 
                -webkit-overflow-scrolling: touch;
            }
            
            .grid-container::-webkit-scrollbar { display: none; }
            .grid-container { -ms-overflow-style: none; scrollbar-width: none; }
            
            .col { 
                flex-direction: row; 
                gap: 0.5rem; 
                width: 100%;
                flex-shrink: 0;
            }
            
            .cell { 
                width: calc((100% - 2rem) / 5); 
                height: auto;
                aspect-ratio: 1 / 1;
                flex: 0 0 auto;
                border-radius: 8px;
            }
            
            .cell-sub { 
                display: block; 
                font-size: 8px;
                opacity: 0.6;
                bottom: 3px;
                letter-spacing: 1px;
            }
            
            .cell-main { 
                font-size: 1.5rem; 
                top: 45%;
            }

            #info-panel {
                height: 60vh !important;
                border-radius: 24px 24px 0 0 !important;
            }

            #panel-content {
                padding: 1.5rem;
                flex-direction: column;
                padding-top: 4rem; 
            }
            
            .btn-action, .btn-close {
                top: 1rem;
            }
            .btn-action { left: 1rem; }
            .btn-close { right: 1rem; }
            
            .panel-handle {
                display: block;
            }

            .char-view { gap: 1rem; }
            .char-val { font-size: 3rem; }
            .char-val-romaji { font-size: 2.5rem; }
            .divider { margin: 0; height: 3rem; }
            .char-label { font-size: 9px; letter-spacing: 1px; }
            .char-group { min-width: auto; height: auto; }
            
            .vocab-header { flex-direction: column; gap: 0.5rem; align-items: flex-start; }
            .vocab-meaning { text-align: left; margin-left: 0; font-size: 1rem; }
            .vocab-word { font-size: 2rem; }
            .vocab-reading { font-size: 1rem; }
            
            .footer-watermark { 
                bottom: calc(1rem + env(safe-area-inset-bottom)); 
                left: 50%; 
                transform: translateX(-50%);
                font-size: 10px; 
                width: max-content;
                background: rgba(0,0,0,0.6);
                padding: 4px 12px;
                border-radius: 20px;
                backdrop-filter: blur(4px);
            }
        }
    </style>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.36.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    
    <!-- Background Effects -->
    <div class="cinematic-glow"></div>
    <canvas id="dustCanvas"></canvas>

    <header>
        <div class="header-group">
            <div class="ui-bar">
                <button class="mode-btn" data-mode="HIRAGANA">HIRA</button>
                <button class="mode-btn" data-mode="KATAKANA">KATA</button>
                <button class="mode-btn active" data-mode="BOTH">ALL</button>
            </div>
        </div>
        
        <button id="btn-settings-toggle" class="icon-btn" title="Settings">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </button>
    </header>

    <!-- Settings Overlay -->
    <div id="settings-overlay"></div>

    <!-- Settings Panel -->
    <div id="settings-panel">
        <div class="settings-toolbar">
            <button id="btn-reset-settings" class="settings-action-btn btn-reset-settings" title="Reset Defaults">
                <svg viewBox="0 0 24 24" stroke="none" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
            </button>
            <button id="btn-settings-close-x" class="settings-action-btn btn-close-settings" title="Close">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>

        <div class="settings-section-title">APPEARANCE</div>

        <div class="control-group">
            <label class="control-label">Cell Size</label>
            <div class="slider-stack">
                <input type="range" id="input-cell-size" min="3.0" max="6.0" step="0.1" value="4.6">
                <div class="slider-labels">
                    <span>Small</span>
                    <span>Large</span>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Grid Spacing</label>
            <div class="slider-stack">
                <input type="range" id="input-grid-gap" min="0" max="2.0" step="0.1" value="0.8">
                <div class="slider-labels">
                    <span>Tight</span>
                    <span>Loose</span>
                </div>
            </div>
        </div>

        <div style="height: 4px;"></div>
        <div class="settings-section-title">PARTICLES</div>

        <div class="control-group">
            <label class="control-label">Density</label>
            <div class="slider-stack">
                <input type="range" id="input-dust-count" min="0" max="400" step="10" value="150">
                <div class="slider-labels">
                    <span>Low</span>
                    <span>High</span>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Flow Speed</label>
            <div class="slider-stack">
                <input type="range" id="input-dust-speed" min="0.1" max="3.0" step="0.1" value="1.0">
                <div class="slider-labels">
                    <span>Slow</span>
                    <span>Fast</span>
                </div>
            </div>
        </div>
    </div>

    <main>
        <div id="grid-root" class="grid-container">
            <!-- Grid generated by JS -->
        </div>
    </main>

    <!-- Footer Watermark -->
    <a href="https://github.com/ihonru/Neon-Gojuon-Wallpaper" target="_blank" class="footer-watermark">@honru</a>

    <!-- The animating panel -->
    <div id="info-panel">
        <div class="panel-bg-glow"></div>
        
        <!-- Drag Handle (Mobile Only) -->
        <div class="panel-handle"></div>

        <!-- Close Button (Updated SVG) -->
        <button id="btn-close-panel" class="btn-close">
            <svg viewBox="0 0 24 24" stroke-width="2"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <div id="panel-content">
            <!-- Content injected by JS -->
        </div>
    </div>

    <script type="module">
        // --- 1. Constants & Data ---
        // Helper to create char objects
        const c = (r, h, k) => ({ id: r, romaji: r, hiragana: h, katakana: k, type: 'main' });
        const empty = (id) => ({ id, type: 'empty' });

        const GOJUON_DATA = [
            // A Row (Columns in JS logic)
            c('a', 'あ', 'ア'), c('i', 'い', 'イ'), c('u', 'う', 'ウ'), c('e', 'え', 'エ'), c('o', 'お', 'オ'),
            // Ka Row
            c('ka', 'か', 'カ'), c('ki', 'き', 'キ'), c('ku', 'く', 'ク'), c('ke', 'け', 'ケ'), c('ko', 'こ', 'コ'),
            // Sa Row
            c('sa', 'さ', 'サ'), c('shi', 'し', 'シ'), c('su', 'す', 'ス'), c('se', 'せ', 'セ'), c('so', 'そ', 'ソ'),
            // Ta Row
            c('ta', 'た', 'タ'), c('chi', 'ち', 'チ'), c('tsu', 'つ', 'ツ'), c('te', 'て', 'テ'), c('to', 'と', 'ト'),
            // Na Row
            c('na', 'な', 'ナ'), c('ni', 'に', 'ニ'), c('nu', 'ぬ', 'ヌ'), c('ne', 'ね', 'ネ'), c('no', 'の', 'ノ'),
            // Ha Row
            c('ha', 'は', 'ハ'), c('hi', 'ひ', 'ヒ'), c('fu', 'ふ', 'フ'), c('he', 'へ', 'ヘ'), c('ho', 'ほ', 'ホ'),
            // Ma Row
            c('ma', 'ま', 'マ'), c('mi', 'み', 'ミ'), c('mu', 'む', 'ム'), c('me', 'め', 'メ'), c('mo', 'も', 'モ'),
            // Ya Row
            c('ya', 'や', 'ヤ'), empty('yi_e'), c('yu', 'ゆ', 'ユ'), empty('ye_e'), c('yo', 'よ', 'ヨ'),
            // Ra Row
            c('ra', 'ら', 'ラ'), c('ri', 'り', 'リ'), c('ru', 'る', 'ル'), c('re', 'れ', 'レ'), c('ro', 'ろ', 'ロ'),
            // Wa Row
            c('wa', 'わ', 'ワ'), empty('wi_e'), empty('wu_e'), empty('we_e'), c('wo', 'を', 'ヲ'),
            // N
            c('n', 'ん', 'ン')
        ];

        // --- 2. EXPANDED OFFLINE DATABASE (2-3 items per char) ---
        const DEFAULT_VOCAB = {
            'a': [
                { word: '雨', reading: 'あめ (ame)', meaning: 'Rain', example: 'あめ が ふっている。 (It is raining.)' },
                { word: '愛', reading: 'あい (ai)', meaning: 'Love', example: 'あい は たいせつ です。 (Love is important.)' },
                { word: '朝', reading: 'あさ (asa)', meaning: 'Morning', example: 'あさ はやく おきる。 (Wake up early in the morning.)' }
            ],
            'i': [
                { word: '犬', reading: 'いぬ (inu)', meaning: 'Dog', example: 'いぬ が います。 (There is a dog.)' },
                { word: '今', reading: 'いま (ima)', meaning: 'Now', example: 'いま なじ ですか。 (What time is it now?)' },
                { word: '忙しい', reading: 'いそがしい (isogashii)', meaning: 'Busy', example: 'きょう は いそがしい。 (I am busy today.)' }
            ],
            'u': [
                { word: '海', reading: 'うみ (umi)', meaning: 'Sea', example: 'うみ に いきたい。 (I want to go to the sea.)' },
                { word: '歌', reading: 'うた (uta)', meaning: 'Song', example: 'うた を うたう。 (Sing a song.)' },
                { word: '後ろ', reading: 'うしろ (ushiro)', meaning: 'Behind', example: 'うしろ を みる。 (Look behind.)' }
            ],
            'e': [
                { word: '駅', reading: 'えき (eki)', meaning: 'Station', example: 'えき で まつ。 (Wait at the station.)' },
                { word: '映画', reading: 'えいが (eiga)', meaning: 'Movie', example: 'えいが を みる。 (Watch a movie.)' },
                { word: '鉛筆', reading: 'えんぴつ (enpitsu)', meaning: 'Pencil', example: 'えんぴつ で かく。 (Write with a pencil.)' }
            ],
            'o': [
                { word: '音楽', reading: 'おんがく (ongaku)', meaning: 'Music', example: 'おんがく を きく。 (Listen to music.)' },
                { word: '大きい', reading: 'おおきい (ookii)', meaning: 'Big', example: 'おおきい いえ。 (A big house.)' },
                { word: 'お金', reading: 'おかね (okane)', meaning: 'Money', example: 'おかね が ない。 (I have no money.)' }
            ],
            'ka': [
                { word: '川', reading: 'かわ (kawa)', meaning: 'River', example: 'かわ で およぐ。 (Swim in the river.)' },
                { word: '傘', reading: 'かさ (kasa)', meaning: 'Umbrella', example: 'かさ を さす。 (Open an umbrella.)' },
                { word: '家族', reading: 'かぞく (kazoku)', meaning: 'Family', example: 'かぞく は よにん です。 (My family has four members.)' }
            ],
            'ki': [
                { word: '木', reading: 'き (ki)', meaning: 'Tree', example: 'おおきな き。 (A big tree.)' },
                { word: '昨日', reading: 'きのう (kinou)', meaning: 'Yesterday', example: 'きのう は あめ でした。 (It rained yesterday.)' },
                { word: '綺麗', reading: 'きれい (kirei)', meaning: 'Beautiful', example: 'はな が きれい です。 (The flowers are beautiful.)' }
            ],
            'ku': [
                { word: '車', reading: 'くるま (kuruma)', meaning: 'Car', example: 'くるま を うんてん する。 (Drive a car.)' },
                { word: '靴', reading: 'くつ (kutsu)', meaning: 'Shoes', example: 'くつ を はく。 (Put on shoes.)' },
                { word: '雲', reading: 'くも (kumo)', meaning: 'Cloud', example: 'しろい くも。 (White clouds.)' }
            ],
            'ke': [
                { word: '警察', reading: 'けいさつ (keisatsu)', meaning: 'Police', example: 'けいさつ を よぶ。 (Call the police.)' },
                { word: '結婚', reading: 'けっこん (kekkon)', meaning: 'Marriage', example: 'けっこん します。 (I am getting married.)' },
                { word: '景色', reading: 'けしき (keshiki)', meaning: 'Scenery', example: 'けしき が いい。 (The scenery is good.)' }
            ],
            'ko': [
                { word: '心', reading: 'こころ (kokoro)', meaning: 'Heart', example: 'こころ が あたたかい。 (Warm hearted.)' },
                { word: '子供', reading: 'こども (kodomo)', meaning: 'Child', example: 'こども が あそぶ。 (Children are playing.)' },
                { word: '声', reading: 'こえ (koe)', meaning: 'Voice', example: 'おおきな こえ。 (A loud voice.)' }
            ],
            'sa': [
                { word: '魚', reading: 'さかな (sakana)', meaning: 'Fish', example: 'さかな を たべる。 (Eat fish.)' },
                { word: '桜', reading: 'さくら (sakura)', meaning: 'Cherry Blossom', example: 'さくら が さいた。 (Cherry blossoms bloomed.)' },
                { word: '酒', reading: 'さけ (sake)', meaning: 'Alcohol', example: 'おさけ を のむ。 (Drink alcohol.)' }
            ],
            'shi': [
                { word: '写真', reading: 'しゃしん (shashin)', meaning: 'Photo', example: 'しゃしん を とる。 (Take a photo.)' },
                { word: '白', reading: 'しろ (shiro)', meaning: 'White', example: 'しろい シャツ。 (White shirt.)' },
                { word: '仕事', reading: 'しごと (shigoto)', meaning: 'Work', example: 'しごと に いく。 (Go to work.)' }
            ],
            'su': [
                { word: '寿司', reading: 'すし (sushi)', meaning: 'Sushi', example: 'すし が すき です。 (I like sushi.)' },
                { word: '好き', reading: 'すき (suki)', meaning: 'Like', example: 'あなた が すき です。 (I like you.)' },
                { word: '少し', reading: 'すこし (sukoshi)', meaning: 'A little', example: 'すこし つかれました。 (I am a little tired.)' }
            ],
            'se': [
                { word: '先生', reading: 'せんせい (sensei)', meaning: 'Teacher', example: 'せんせい に きく。 (Ask the teacher.)' },
                { word: '世界', reading: 'せかい (sekai)', meaning: 'World', example: 'せかい を りょこう する。 (Travel the world.)' },
                { word: '背中', reading: 'せなか (senaka)', meaning: 'Back', example: 'せなか が かゆい。 (My back itches.)' }
            ],
            'so': [
                { word: '空', reading: 'そら (sora)', meaning: 'Sky', example: 'あおい そら。 (Blue sky.)' },
                { word: '掃除', reading: 'そうじ (souji)', meaning: 'Cleaning', example: 'へや を そうじ する。 (Clean the room.)' },
                { word: '外', reading: 'そと (soto)', meaning: 'Outside', example: 'そと に でる。 (Go outside.)' }
            ],
            'ta': [
                { word: '食べる', reading: 'たべる (taberu)', meaning: 'To eat', example: 'ごはん を たべる。 (Eat rice.)' },
                { word: '高い', reading: 'たかい (takai)', meaning: 'High/Expensive', example: 'この ほん は たかい。 (This book is expensive.)' },
                { word: '卵', reading: 'たまご (tamago)', meaning: 'Egg', example: 'たまご を かう。 (Buy eggs.)' }
            ],
            'chi': [
                { word: '地下鉄', reading: 'ちかてつ (chikatetsu)', meaning: 'Subway', example: 'ちかてつ に のる。 (Ride the subway.)' },
                { word: '小さい', reading: 'ちいさい (chiisai)', meaning: 'Small', example: 'ちいさい ねこ。 (Small cat.)' },
                { word: '地図', reading: 'ちず (chizu)', meaning: 'Map', example: 'ちず を みる。 (Look at the map.)' }
            ],
            'tsu': [
                { word: '月', reading: 'つき (tsuki)', meaning: 'Moon', example: 'つき が きれい です。 (The moon is beautiful.)' },
                { word: '机', reading: 'つくえ (tsukue)', meaning: 'Desk', example: 'つくえ の うえ。 (On the desk.)' },
                { word: '作る', reading: 'つくる (tsukuru)', meaning: 'To make', example: 'りょうり を つくる。 (Cook food.)' }
            ],
            'te': [
                { word: '手', reading: 'て (te)', meaning: 'Hand', example: 'て を あらう。 (Wash hands.)' },
                { word: '天気', reading: 'てんき (tenki)', meaning: 'Weather', example: 'いい てんき です。 (It is good weather.)' },
                { word: '手紙', reading: 'てがみ (tegami)', meaning: 'Letter', example: 'てがみ を かく。 (Write a letter.)' }
            ],
            'to': [
                { word: '時計', reading: 'とけい (tokei)', meaning: 'Clock', example: 'とけい を みる。 (Check the watch.)' },
                { word: '友達', reading: 'ともだち (tomodachi)', meaning: 'Friend', example: 'ともだち と あそぶ。 (Play with friends.)' },
                { word: '鳥', reading: 'とり (tori)', meaning: 'Bird', example: 'とり が とぶ。 (Birds fly.)' }
            ],
            'na': [
                { word: '名前', reading: 'なまえ (namae)', meaning: 'Name', example: 'なまえ を かく。 (Write your name.)' },
                { word: '夏', reading: 'なつ (natsu)', meaning: 'Summer', example: 'なつ は あつい。 (Summer is hot.)' },
                { word: '中', reading: 'なか (naka)', meaning: 'Inside', example: 'はこの なか。 (Inside the box.)' }
            ],
            'ni': [
                { word: '日本', reading: 'にほん (nihon)', meaning: 'Japan', example: 'にほん に いきたい。 (I want to go to Japan.)' },
                { word: '肉', reading: 'にく (niku)', meaning: 'Meat', example: 'にく を たべる。 (Eat meat.)' },
                { word: '西', reading: 'にし (nishi)', meaning: 'West', example: 'にし の ほう。 (To the west.)' }
            ],
            'nu': [
                { word: 'ぬいぐるみ', reading: 'ぬいぐるみ (nuigurumi)', meaning: 'Plush Toy', example: 'くま の ぬいぐるみ。 (Bear plush toy.)' },
                { word: '脱ぐ', reading: 'ぬぐ (nugu)', meaning: 'To take off', example: 'くつ を ぬぐ。 (Take off shoes.)' },
                { word: '塗る', reading: 'ぬる (nuru)', meaning: 'To paint', example: 'ペンキ を ぬる。 (Paint with paint.)' }
            ],
            'ne': [
                { word: '猫', reading: 'ねこ (neko)', meaning: 'Cat', example: 'ねこ が ねている。 (The cat is sleeping.)' },
                { word: '寝る', reading: 'ねる (neru)', meaning: 'To sleep', example: 'はやく ねる。 (Go to sleep early.)' },
                { word: '熱', reading: 'ねつ (netsu)', meaning: 'Fever', example: 'ねつ が ある。 (I have a fever.)' }
            ],
            'no': [
                { word: '飲み物', reading: 'のみもの (nomimono)', meaning: 'Drink', example: 'のみもの を かう。 (Buy a drink.)' },
                { word: '海苔', reading: 'のり (nori)', meaning: 'Seaweed', example: 'のり を たべる。 (Eat seaweed.)' },
                { word: '登る', reading: 'のぼる (noboru)', meaning: 'To climb', example: 'やま に のぼる。 (Climb a mountain.)' }
            ],
            'ha': [
                { word: '花', reading: 'はな (hana)', meaning: 'Flower', example: 'はな が さく。 (Flowers bloom.)' },
                { word: '春', reading: 'はる (haru)', meaning: 'Spring', example: 'はる に なる。 (It becomes spring.)' },
                { word: '晴れ', reading: 'はれ (hare)', meaning: 'Sunny', example: 'きょう は はれ です。 (Today is sunny.)' }
            ],
            'hi': [
                { word: '飛行機', reading: 'ひこうき (hikouki)', meaning: 'Airplane', example: 'ひこうき で いく。 (Go by plane.)' },
                { word: '人', reading: 'ひと (hito)', meaning: 'Person', example: 'あの ひと は だれ？ (Who is that person?)' },
                { word: '昼', reading: 'ひる (hiru)', meaning: 'Noon/Daytime', example: 'ひるごはん を たべる。 (Eat lunch.)' }
            ],
            'fu': [
                { word: '冬', reading: 'ふゆ (fuyu)', meaning: 'Winter', example: 'ふゆ は さむい です。 (Winter is cold.)' },
                { word: '服', reading: 'ふく (fuku)', meaning: 'Clothes', example: 'あたらしい ふく。 (New clothes.)' },
                { word: '風呂', reading: 'ふろ (furo)', meaning: 'Bath', example: 'おふろ に はいる。 (Take a bath.)' }
            ],
            'he': [
                { word: '部屋', reading: 'へや (heya)', meaning: 'Room', example: 'へや を かたづける。 (Clean the room.)' },
                { word: '下手', reading: 'へた (heta)', meaning: 'Unskilled', example: 'うた が へた です。 (I am bad at singing.)' },
                { word: '平和', reading: 'へいわ (heiwa)', meaning: 'Peace', example: 'せかい の へいわ。 (World peace.)' }
            ],
            'ho': [
                { word: '本', reading: 'ほん (hon)', meaning: 'Book', example: 'ほん を よむ。 (Read a book.)' },
                { word: '星', reading: 'ほし (hoshi)', meaning: 'Star', example: 'ほし が ひかる。 (Stars are shining.)' },
                { word: '欲しい', reading: 'ほしい (hoshii)', meaning: 'Want', example: 'みず が ほしい。 (I want water.)' }
            ],
            'ma': [
                { word: '毎日', reading: 'まいにち (mainichi)', meaning: 'Every day', example: 'まいにち べんきょう する。 (Study every day.)' },
                { word: '前', reading: 'まえ (mae)', meaning: 'Front/Before', example: 'えき の まえ。 (In front of the station.)' },
                { word: '町', reading: 'まち (machi)', meaning: 'Town', example: 'しずかな まち。 (A quiet town.)' }
            ],
            'mi': [
                { word: '店', reading: 'みせ (mise)', meaning: 'Shop', example: 'みせ に いく。 (Go to the shop.)' },
                { word: '道', reading: 'みち (michi)', meaning: 'Road', example: 'みち を あるく。 (Walk on the road.)' },
                { word: '耳', reading: 'みみ (mimi)', meaning: 'Ear', example: 'みみ が いたい。 (My ear hurts.)' }
            ],
            'mu': [
                { word: '虫', reading: 'むし (mushi)', meaning: 'Insect', example: 'むし が いる。 (There is an insect.)' },
                { word: '昔', reading: 'むかし (mukashi)', meaning: 'Old times', example: 'むかし むかし。 (Once upon a time.)' },
                { word: '難しい', reading: 'むずかしい (muzukashii)', meaning: 'Difficult', example: 'にほんご は むずかしい。 (Japanese is difficult.)' }
            ],
            'me': [
                { word: '目', reading: 'め (me)', meaning: 'Eye', example: 'め が かゆい。 (My eyes are itchy.)' },
                { word: '眼鏡', reading: 'めがね (megane)', meaning: 'Glasses', example: 'めがね を かける。 (Put on glasses.)' },
                { word: '名刺', reading: 'めいし (meishi)', meaning: 'Business card', example: 'めいし を こうかん する。 (Exchange business cards.)' }
            ],
            'mo': [
                { word: '森', reading: 'もり (mori)', meaning: 'Forest', example: 'もり に いく。 (Go to the forest.)' },
                { word: '物', reading: 'もの (mono)', meaning: 'Thing', example: 'おいしい もの。 (Delicious things.)' },
                { word: 'もしもし', reading: 'もしもし (moshimoshi)', meaning: 'Hello (phone)', example: 'もしもし、たなか です。 (Hello, this is Tanaka.)' }
            ],
            'ya': [
                { word: '山', reading: 'やま (yama)', meaning: 'Mountain', example: 'やま に のぼる。 (Climb a mountain.)' },
                { word: '野菜', reading: 'やさい (yasai)', meaning: 'Vegetable', example: 'やさい を たべる。 (Eat vegetables.)' },
                { word: '休み', reading: 'やすみ (yasumi)', meaning: 'Rest/Holiday', example: 'あした は やすみ です。 (Tomorrow is a holiday.)' }
            ],
            'yu': [
                { word: '雪', reading: 'ゆき (yuki)', meaning: 'Snow', example: 'ゆき が ふる。 (Snow falls.)' },
                { word: '夢', reading: 'ゆめ (yume)', meaning: 'Dream', example: 'ゆめ を みる。 (Have a dream.)' },
                { word: '有名', reading: 'ゆうめい (yuumei)', meaning: 'Famous', example: 'ゆうめいな ひと。 (A famous person.)' }
            ],
            'yo': [
                { word: '夜', reading: 'よる (yoru)', meaning: 'Night', example: 'よる に なる。 (It becomes night.)' },
                { word: '読む', reading: 'よむ (yomu)', meaning: 'To read', example: 'ほん を よむ。 (Read a book.)' },
                { word: '洋服', reading: 'ようふく (youfuku)', meaning: 'Western clothes', example: 'ようふく を かう。 (Buy western clothes.)' }
            ],
            'ra': [
                { word: '来週', reading: 'らいしゅう (raishuu)', meaning: 'Next week', example: 'らいしゅう あいましょう。 (Let\'s meet next week.)' },
                { word: 'ラーメン', reading: 'らーめん (raamen)', meaning: 'Ramen', example: 'ラーメン を たべる。 (Eat ramen.)' },
                { word: 'ラジオ', reading: 'らじお (rajio)', meaning: 'Radio', example: 'ラジオ を きく。 (Listen to the radio.)' }
            ],
            'ri': [
                { word: '料理', reading: 'りょうり (ryouri)', meaning: 'Cooking', example: 'りょうり を つくる。 (Cook food.)' },
                { word: '林檎', reading: 'りんご (ringo)', meaning: 'Apple', example: 'あかい りんご。 (Red apple.)' },
                { word: '旅行', reading: 'りょこう (ryokou)', meaning: 'Travel', example: 'にほん へ りょこう する。 (Travel to Japan.)' }
            ],
            'ru': [
                { word: '留守', reading: 'るす (rusu)', meaning: 'Not at home', example: 'ちち は るす です。 (My father is not home.)' },
                { word: 'ルール', reading: 'るーる (ruuru)', meaning: 'Rule', example: 'ルール を まもる。 (Follow the rules.)' },
                { word: 'ルビー', reading: 'るびー (rubii)', meaning: 'Ruby', example: 'あかい ルビー。 (Red ruby.)' }
            ],
            're': [
                { word: '冷蔵庫', reading: 'れいぞうこ (reizouko)', meaning: 'Refrigerator', example: 'れいぞうこ に いれる。 (Put in the refrigerator.)' },
                { word: '練習', reading: 'れんしゅう (renshuu)', meaning: 'Practice', example: 'ピアノ を れんしゅう する。 (Practice piano.)' },
                { word: 'レストラン', reading: 'れすとらん (resutoran)', meaning: 'Restaurant', example: 'レストラン で たべる。 (Eat at a restaurant.)' }
            ],
            'ro': [
                { word: '六', reading: 'ろく (roku)', meaning: 'Six', example: 'りんご が ろっこ ある。 (There are six apples.)' },
                { word: '廊下', reading: 'ろうか (rouka)', meaning: 'Corridor', example: 'ろうか を はしらない。 (Do not run in the corridor.)' },
                { word: 'ろうそく', reading: 'ろうそく (rousoku)', meaning: 'Candle', example: 'ろうそく を つける。 (Light a candle.)' }
            ],
            'wa': [
                { word: '私', reading: 'わたし (watashi)', meaning: 'I/Me', example: 'わたし は ガク です。 (I am Gaku.)' },
                { word: '和食', reading: 'わしょく (washoku)', meaning: 'Japanese food', example: 'わしょく が すき です。 (I like Japanese food.)' },
                { word: '忘れ物', reading: 'わすれもの (wasuremono)', meaning: 'Lost article', example: 'わすれもの に ちゅうい。 (Be careful of lost items.)' }
            ],
            'wo': [
                { word: 'を', reading: 'を (wo)', meaning: 'Object particle', example: 'これ を ください。 (Please give me this.)' },
                { word: '〜を', reading: '〜を (wo)', meaning: 'Particle', example: 'みず を のむ。 (Drink water.)' }
            ],
            'n': [
                { word: '運', reading: 'うん (un)', meaning: 'Luck', example: 'うん が いい。 (Good luck.)' },
                { word: '運動', reading: 'うんどう (undou)', meaning: 'Exercise', example: 'まいにち うんどう する。 (Exercise every day.)' },
                { word: '運転', reading: 'うんてん (unten)', meaning: 'Driving', example: 'くるま の うんてん。 (Driving a car.)' }
            ]
        };

        let VOCAB_DB = JSON.parse(JSON.stringify(DEFAULT_VOCAB));

        // Load local storage and merge with defaults
        try {
            const stored = localStorage.getItem('neon_gojuon_vocab');
            if (stored) {
                const parsed = JSON.parse(stored);
                // Merge: If local has keys, append/replace.
                Object.keys(parsed).forEach(key => {
                    if (VOCAB_DB[key]) {
                        // Ensure we have unique items based on 'word'
                        const existingWords = new Set(VOCAB_DB[key].map(i => i.word));
                        parsed[key].forEach(newItem => {
                            if (!existingWords.has(newItem.word)) {
                                VOCAB_DB[key].push(newItem);
                            }
                        });
                    } else {
                        VOCAB_DB[key] = parsed[key];
                    }
                });
                console.log("Merged vocabulary from local storage.");
            }
        } catch (e) {
            console.error("Failed to load local storage", e);
        }

        // --- 3. State & Settings ---
        const state = {
            mode: 'BOTH',
            selectedChar: null,
            activeCellId: null,
            activeCellRect: null,
            vocabulary: null,
            vocabIndex: -1, // Track index to ensure rotation
            error: null,
            isPanelOpen: false,
            isSettingsOpen: false
        };

        const defaultSettings = {
            cellSize: 4.6,
            gridGap: 0.8,
            dustCount: 150,
            dustSpeed: 1.0
        };

        let appSettings = {...defaultSettings};
        
        // Load Settings
        try {
            const storedSettings = localStorage.getItem('neon_gojuon_settings');
            if(storedSettings) {
                appSettings = { ...defaultSettings, ...JSON.parse(storedSettings) };
            }
        } catch(e) { console.error("Error loading settings", e); }
        
        // Apply initial CSS variables
        const r = document.documentElement;
        r.style.setProperty('--cell-size', `${appSettings.cellSize}rem`);
        r.style.setProperty('--grid-gap', `${appSettings.gridGap}rem`);


        // --- 4. Render Logic ---
        const gridRoot = document.getElementById('grid-root');
        const infoPanel = document.getElementById('info-panel');
        const panelContent = document.getElementById('panel-content');
        const btnClose = document.getElementById('btn-close-panel');
        const modeBtns = document.querySelectorAll('.mode-btn');

        // Initial Render
        function initGrid() {
            gridRoot.innerHTML = '';
            // Chunk into columns of 5 (Standard Vertical Layout)
            for (let i = 0; i < GOJUON_DATA.length; i += 5) {
                const chunk = GOJUON_DATA.slice(i, i + 5);
                const col = document.createElement('div');
                col.className = 'col';
                
                chunk.forEach(char => {
                    const cell = document.createElement('div');
                    cell.className = 'cell'; // Base class for everyone for identical box model

                    if (char.type === 'empty') {
                        cell.classList.add('empty-cell');
                    } else {
                        cell.id = `cell-${char.id}`;
                        
                        // Local Mouse Tracking for Glow Effect (on the individual cell)
                        cell.onmousemove = (e) => {
                            const rect = cell.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            cell.style.setProperty('--x', `${x}px`);
                            cell.style.setProperty('--y', `${y}px`);
                        };

                        // Interaction
                        cell.onclick = (e) => {
                            e.stopPropagation();
                            if (state.isPanelOpen) return;
                            openPanel(char, cell);
                        };
                        
                        // Main Text
                        const mainSpan = document.createElement('span');
                        mainSpan.className = 'cell-main';
                        cell.appendChild(mainSpan);

                        // Sub Text
                        const subSpan = document.createElement('span');
                        subSpan.className = 'cell-sub';
                        cell.appendChild(subSpan);
                    }
                    col.appendChild(cell);
                });
                gridRoot.appendChild(col);
            }
            updateGridVisuals();
        }

        function updateGridVisuals() {
            GOJUON_DATA.forEach(char => {
                if (char.type === 'empty') return;
                const cell = document.getElementById(`cell-${char.id}`);
                const main = cell.querySelector('.cell-main');
                const sub = cell.querySelector('.cell-sub');
                
                // Update text based on mode
                if (state.mode === 'HIRAGANA') {
                    main.textContent = char.hiragana;
                    sub.textContent = char.romaji;
                } else if (state.mode === 'KATAKANA') {
                    main.textContent = char.katakana;
                    sub.textContent = char.romaji;
                } else {
                    main.textContent = char.hiragana;
                    sub.textContent = char.katakana;
                }
            });
        }

        // --- 5. Panel Animation Logic ---
        
        function openPanel(char, cellElement) {
            state.selectedChar = char;
            state.vocabulary = null;
            state.vocabIndex = -1;
            state.error = null;
            state.activeCellId = cellElement.id;
            state.isPanelOpen = true;

            const isMobile = window.innerWidth <= 768;

            // 1. Measure the cell
            const rect = cellElement.getBoundingClientRect();
            state.activeCellRect = rect;

            // 2. Hide the cell (placeholder state)
            cellElement.classList.add('placeholder');

            // 3. Set initial position of panel
            infoPanel.style.display = 'block';

            if (isMobile) {
                // Mobile: Prepare for slide up from bottom
                infoPanel.style.top = 'auto';
                infoPanel.style.bottom = '0';
                infoPanel.style.left = '0';
                infoPanel.style.width = '100%';
                infoPanel.style.height = '60dvh'; // Use dvh for mobile address bar
                infoPanel.style.transform = 'translateY(100%)'; // Start off-screen
                infoPanel.style.borderRadius = '24px 24px 0 0';
            } else {
                // Desktop: Match cell position for morph
                infoPanel.style.top = `${rect.top}px`;
                infoPanel.style.left = `${rect.left}px`;
                infoPanel.style.width = `${rect.width}px`;
                infoPanel.style.height = `${rect.height}px`;
                infoPanel.style.transform = 'none';
                // Adjust border radius to match the concentric design
                infoPanel.style.borderRadius = getComputedStyle(cellElement).borderRadius;
            }

            // 4. Force reflow
            infoPanel.offsetHeight;

            // 5. Animate to final state
            infoPanel.classList.add('open');
            
            if (isMobile) {
                // Slide in
                infoPanel.style.transform = 'translateY(0)';
            } else {
                // Morph to center
                const targetWidth = Math.min(window.innerWidth * 0.9, 800);
                const targetHeight = 300;
                
                infoPanel.style.top = '50%';
                infoPanel.style.left = '50%';
                infoPanel.style.width = `${targetWidth}px`;
                infoPanel.style.height = `${targetHeight}px`;
                infoPanel.style.transform = 'translate(-50%, -50%)';
                // Final concentric radius
                infoPanel.style.borderRadius = '48px'; 
            }

            // 6. Render content
            renderPanelContent();
        }

        function closePanel() {
            if (!state.isPanelOpen) return;

            infoPanel.classList.remove('open');
            state.isPanelOpen = false;

            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                // Slide out
                infoPanel.style.transform = 'translateY(100%)';
            } else if (state.activeCellRect) {
                // Morph back
                const rect = state.activeCellRect;
                infoPanel.style.top = `${rect.top}px`;
                infoPanel.style.left = `${rect.left}px`;
                infoPanel.style.width = `${rect.width}px`;
                infoPanel.style.height = `${rect.height}px`;
                infoPanel.style.transform = 'none';
                infoPanel.style.borderRadius = '0.75rem';
            }

            setTimeout(() => {
                infoPanel.style.display = 'none';
                
                const cell = document.getElementById(state.activeCellId);
                if (cell) {
                    cell.classList.remove('placeholder');
                }
                
                state.selectedChar = null;
                state.activeCellId = null;
            }, 300); // Faster close animation match
        }

        function renderPanelContent() {
            panelContent.innerHTML = '';

            // Button Logic
            let btnHtml = '';
            if (state.vocabulary) {
                // Refresh Icon (Moved to left in CSS, no change needed here)
                btnHtml = `
                    <button class="btn-action" id="btn-action-trigger" title="Another Example">
                        <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    </button>
                `;
            } else if (state.selectedChar) {
                // Example Button
                btnHtml = `<button class="btn-action" id="btn-action-trigger">例</button>`;
            }

            if (state.error) {
                panelContent.innerHTML = `
                    ${btnHtml}
                    <div class="error-view">
                        <div style="border:1px solid var(--neon-pink); padding:2px 6px; font-size:10px; color:var(--neon-pink);">SYSTEM WARNING</div>
                        <div style="font-weight:300;">${state.error}</div>
                    </div>
                `;
            } else if (state.vocabulary) {
                const v = state.vocabulary;
                panelContent.innerHTML = `
                    ${btnHtml}
                    <div class="vocab-view">
                        <div class="vocab-header">
                            <div>
                                <div style="font-size:10px; color:var(--neon-pink); letter-spacing:2px; margin-bottom:4px;">VOCABULARY</div>
                                <div class="vocab-main">
                                    <span class="vocab-word">${v.word}</span>
                                    <span class="vocab-reading">${v.reading}</span>
                                </div>
                            </div>
                            <div class="vocab-meaning">${v.meaning}</div>
                        </div>
                        <div class="vocab-example">"${v.example}"</div>
                    </div>
                `;
            } else if (state.selectedChar) {
                const c = state.selectedChar;
                panelContent.innerHTML = `
                    ${btnHtml}
                    <div class="char-view">
                        <div class="char-group">
                            <span class="char-label">HIRAGANA</span>
                            <span class="char-val">${c.hiragana}</span>
                        </div>
                        <div class="divider"></div>
                        <div class="char-group">
                            <span class="char-label" style="color:var(--neon-pink);">KATAKANA</span>
                            <span class="char-val">${c.katakana}</span>
                        </div>
                        <div class="divider"></div>
                        <div class="char-group">
                            <span class="char-label" style="color:var(--neon-blue);">ROMAJI</span>
                            <span class="char-val-romaji">${c.romaji}</span>
                        </div>
                    </div>
                `;
            }
        }

        // --- 6. Interactions ---
        modeBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if(state.isPanelOpen) closePanel();
                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.mode = btn.dataset.mode;
                updateGridVisuals();
            });
        });
        
        // Explicit Close Button logic
        btnClose.addEventListener('click', (e) => {
             e.stopPropagation();
             closePanel();
        });

        window.addEventListener('click', (e) => {
            if (state.isPanelOpen && !infoPanel.contains(e.target)) {
                closePanel();
            }
        });

        panelContent.addEventListener('click', (e) => {
            if (e.target.closest('#btn-action-trigger')) {
                e.stopPropagation();
                // Fetch from LOCAL DB.
                displayLocalVocab();
            }
        });
        
        // --- Settings Panel Logic ---
        const btnSettingsToggle = document.getElementById('btn-settings-toggle');
        const btnSettingsCloseX = document.getElementById('btn-settings-close-x');
        const btnResetSettings = document.getElementById('btn-reset-settings');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsOverlay = document.getElementById('settings-overlay');
        
        // Inputs
        const inputs = {
            cellSize: document.getElementById('input-cell-size'),
            gridGap: document.getElementById('input-grid-gap'),
            dustCount: document.getElementById('input-dust-count'),
            dustSpeed: document.getElementById('input-dust-speed')
        };

        // Initialize UI values
        function syncInputs() {
            Object.keys(inputs).forEach(key => {
                inputs[key].value = appSettings[key];
            });
        }
        syncInputs();

        function saveSettings() {
            localStorage.setItem('neon_gojuon_settings', JSON.stringify(appSettings));
        }
        
        function applyVisuals() {
             document.documentElement.style.setProperty('--cell-size', appSettings.cellSize + 'rem');
             document.documentElement.style.setProperty('--grid-gap', appSettings.gridGap + 'rem');
        }

        function openSettings() {
            settingsPanel.classList.add('active');
            settingsOverlay.classList.add('active');
            // Ensure inputs match current actual settings (in case user reset but didn't save)
            syncInputs();
        }

        function closeSettings() {
            settingsPanel.classList.remove('active');
            settingsOverlay.classList.remove('active');
        }

        btnSettingsToggle.onclick = openSettings;
        btnSettingsCloseX.onclick = closeSettings;
        settingsOverlay.onclick = closeSettings;
        
        // "Reset" Button Action
        btnResetSettings.onclick = () => {
            appSettings = {...defaultSettings};
            syncInputs();
            applyVisuals();
            // Debounce restart dust
            if(window.dustTimeout) clearTimeout(window.dustTimeout);
            window.dustTimeout = setTimeout(() => {
                restartDustSystem();
            }, 300);
            saveSettings();
        };

        // Event Listeners for sliders (Live Preview + Auto Save)
        inputs.cellSize.oninput = (e) => {
            const val = parseFloat(e.target.value);
            appSettings.cellSize = val;
            document.documentElement.style.setProperty('--cell-size', val + 'rem');
        };
        inputs.cellSize.onchange = saveSettings;

        inputs.gridGap.oninput = (e) => {
            const val = parseFloat(e.target.value);
            appSettings.gridGap = val;
            document.documentElement.style.setProperty('--grid-gap', val + 'rem');
        };
        inputs.gridGap.onchange = saveSettings;

        inputs.dustCount.oninput = (e) => {
            const val = parseInt(e.target.value);
            appSettings.dustCount = val;
            // Debounce restart
            if(window.dustTimeout) clearTimeout(window.dustTimeout);
            window.dustTimeout = setTimeout(() => {
                restartDustSystem();
            }, 300);
        };
        inputs.dustCount.onchange = saveSettings;

        inputs.dustSpeed.oninput = (e) => {
            const val = parseFloat(e.target.value);
            appSettings.dustSpeed = val;
        };
        inputs.dustSpeed.onchange = saveSettings;


        // --- 7. Swipe Gestures for Tab Switching (Background) ---
        let touchStartX = 0;
        let touchStartY = 0;

        window.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: false});

        window.addEventListener('touchend', (e) => {
            if (state.isPanelOpen) return; // Only when no popup is open

            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            
            handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
        }, {passive: false});

        function handleSwipe(sx, sy, ex, ey) {
            const dx = ex - sx;
            const dy = ey - sy;
            
            // Threshold 50px, and horizontal movement must be greater than vertical
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) {
                // Horizontal swipe
                if (dx > 0) {
                    // Swipe Right -> Go to Previous Tab
                    cycleMode(-1);
                } else {
                    // Swipe Left -> Go to Next Tab
                    cycleMode(1);
                }
            }
        }

        const MODES = ['HIRAGANA', 'KATAKANA', 'BOTH'];
        function cycleMode(direction) {
            const currentIdx = MODES.indexOf(state.mode);
            let nextIdx = currentIdx + direction;
            if (nextIdx < 0) nextIdx = MODES.length - 1;
            if (nextIdx >= MODES.length) nextIdx = 0;
            
            const nextMode = MODES[nextIdx];
            const btn = document.querySelector(`.mode-btn[data-mode="${nextMode}"]`);
            if (btn) btn.click();
        }

        // --- 8. Mobile Pull-to-Close Logic (Foreground Panel) ---
        const panelDragState = {
            startY: 0,
            currentY: 0,
            isDragging: false
        };

        infoPanel.addEventListener('touchstart', (e) => {
            if (window.innerWidth > 768) return;
            
            panelDragState.startY = e.touches[0].clientY;
            panelDragState.isDragging = true;
            panelDragState.currentY = 0;
            
            // Remove transition for instant tracking
            infoPanel.style.transition = 'none';
        }, {passive: true});

        infoPanel.addEventListener('touchmove', (e) => {
            if (!panelDragState.isDragging) return;
            
            const deltaY = e.touches[0].clientY - panelDragState.startY;
            
            // Only allow dragging down (positive deltaY)
            if (deltaY > 0) {
                // Check if we want to prevent scrolling (optional, if content overflows)
                // For now, assume drag-to-dismiss is primary action from top handle area
                // e.preventDefault(); 
                
                panelDragState.currentY = deltaY;
                infoPanel.style.transform = `translateY(${deltaY}px)`;
            }
        }, {passive: false});

        infoPanel.addEventListener('touchend', (e) => {
            if (!panelDragState.isDragging) return;
            panelDragState.isDragging = false;
            
            // Restore transition
            infoPanel.style.transition = 'all 0.3s cubic-bezier(0.25, 1, 0.5, 1)';
            
            // Threshold to close (e.g., 100px)
            if (panelDragState.currentY > 100) {
                closePanel();
            } else {
                // Bounce back if didn't cross threshold
                if (panelDragState.currentY > 0) {
                     infoPanel.style.transform = 'translateY(0)';
                }
            }
            panelDragState.currentY = 0;
        });

        // --- 9. LOGIC ---
        
        // Displays a random vocabulary from the LOCAL database
        function displayLocalVocab() {
            if (!state.selectedChar) return;
            
            const charId = state.selectedChar.id;
            const vocabList = VOCAB_DB[charId];

            if (vocabList && vocabList.length > 0) {
                // Logic to pick a random index but try to change it if possible
                let newIndex;
                if (vocabList.length === 1) {
                    newIndex = 0;
                } else {
                    // Pick random, avoid current if possible
                    do {
                        newIndex = Math.floor(Math.random() * vocabList.length);
                    } while (newIndex === state.vocabIndex && vocabList.length > 1);
                }

                state.vocabIndex = newIndex;
                state.vocabulary = vocabList[newIndex];
                state.error = null;
            } else {
                state.error = "No data found.";
                state.vocabulary = null;
            }
            renderPanelContent();
        }

        // --- 10. BACKGROUND DUST SYSTEM ---
        
        // Need global reference to restart
        let dustSystem = {
            init: null,
            resize: null,
            particles: []
        };
        
        function initDustSystem() {
            const canvas = document.getElementById('dustCanvas');
            const ctx = canvas.getContext('2d');

            const mouse = { x: -1000, y: -1000, radius: 150 };

            // Light source info (Dynamic)
            let lightInfo = {
                centerX: 0,
                centerY: 0,
                maxRadius: 750 
            };

            window.addEventListener('mousemove', (e) => { 
                mouse.x = e.clientX; 
                mouse.y = e.clientY; 
            });
            
            dustSystem.resize = function() {
                // Handle High DPI scaling for clearer particles
                const dpr = window.devicePixelRatio || 1;
                canvas.width = window.innerWidth * dpr;
                canvas.height = window.innerHeight * dpr;
                ctx.scale(dpr, dpr);
                // Reset CSS dimensions to match screen
                canvas.style.width = window.innerWidth + 'px';
                canvas.style.height = window.innerHeight + 'px';
                
                lightInfo.centerY = window.innerHeight + 150; 
                lightInfo.centerX = window.innerWidth / 2;
            }
            
            window.addEventListener('resize', dustSystem.resize);
            
            class Particle {
                constructor() { 
                    this.reset(true);
                }

                reset(initial = false) {
                    const w = window.innerWidth;
                    const h = window.innerHeight;
                    
                    this.x = Math.random() * w;
                    this.y = initial ? Math.random() * h : h + 20;
                    
                    // Z-Depth: 0 (far) to 1 (near)
                    this.z = Math.random(); 
                    
                    // Size is affected by depth (Front ones larger)
                    // Base size 0.5 to 1.5, multiplied by depth factor
                    this.r = (Math.random() * 0.5 + 0.5) * (1 + this.z); 
                    
                    this.baseVy = -(Math.random() * 0.4 + 0.1); 
                    this.vx = 0;
                    this.vy = 0;
                    this.ax = 0;
                    this.ay = 0;
                    this.phase = Math.random() * Math.PI * 2; 
                }

                update() {
                    // Parallax/Depth speed multiplier (Front moves slightly faster)
                    // Apply global speed setting
                    const speedMult = (0.5 + (this.z * 0.5)) * appSettings.dustSpeed;

                    // 1. Natural Flow
                    this.phase += 0.01;
                    const sway = Math.sin(this.phase) * 0.05 * speedMult;
                    
                    // 2. Mouse Repulsion Physics
                    let dx = this.x - mouse.x;
                    let dy = this.y - mouse.y;
                    let dist = Math.sqrt(dx * dx + dy * dy);
                    const repulsionRadius = 150 * (1 + this.z * 0.5); 

                    if (dist < repulsionRadius) {
                        const force = (repulsionRadius - dist) / repulsionRadius;
                        const angle = Math.atan2(dy, dx);
                        this.ax += Math.cos(angle) * force * 0.5 * speedMult;
                        this.ay += Math.sin(angle) * force * 0.5 * speedMult;
                    }

                    this.vx += this.ax;
                    this.vy += this.ay;
                    
                    this.x += (this.vx + sway);
                    this.y += (this.vy + this.baseVy * speedMult);

                    this.vx *= 0.95;
                    this.vy *= 0.95;
                    this.ax = 0;
                    this.ay = 0;

                    const w = window.innerWidth;
                    const h = window.innerHeight;

                    if (this.y < -50) this.reset();
                    if (this.x > w + 50) this.x = -50;
                    if (this.x < -50) this.x = w + 50;
                }

                draw() {
                    const dx = this.x - lightInfo.centerX;
                    const dy = this.y - lightInfo.centerY;
                    const distSq = dx * dx + dy * dy;
                    const maxDistSq = lightInfo.maxRadius * lightInfo.maxRadius;

                    if (distSq < maxDistSq) {
                        const intensity = Math.pow(1 - (distSq / maxDistSq), 2);
                        const depthAlpha = 0.4 + (this.z * 0.6); 
                        const alpha = intensity * depthAlpha; 

                        if (alpha > 0.01) {
                            ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                            ctx.beginPath();
                            ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
            }

            dustSystem.init = function() {
                dustSystem.resize();
                dustSystem.particles = [];
                for (let i = 0; i < appSettings.dustCount; i++) {
                    dustSystem.particles.push(new Particle());
                }
            }

            function animate(time) {
                const period = 25000;
                const amplitude = 150; 
                const t = (time % period) / period * Math.PI * 2;
                const offset = -Math.cos(t) * amplitude;
                
                lightInfo.centerX = (window.innerWidth / 2) + offset;
                
                const w = window.innerWidth;
                const h = window.innerHeight;

                ctx.clearRect(0, 0, w, h);
                
                dustSystem.particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                
                requestAnimationFrame(animate);
            }

            dustSystem.init();
            requestAnimationFrame(animate);
        }

        function restartDustSystem() {
            if(dustSystem.init) dustSystem.init();
        }

        // Initialize App
        initGrid();
        initDustSystem();

    </script>
</body>
</html>